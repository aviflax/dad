#!/bin/bash

# This script is meant to run within GitHub Actions (GHA). Its purpose is to set the environment
# variables RELEASE_TAG and PRERELEASE for use by subsequent steps in a GHA job.

set -eu

# Docs on the env vars prefixed with GITHUB_ may be found here:
#  https://help.github.com/en/actions/configuring-and-managing-workflows/using-environment-variables

if [[ $GITHUB_REF == 'master' ]]; then
  # I’m not super interested in the concept of version numbers; they’re super arbitrary.
  # That said, I’m planning to publish a Homebrew formula for this tool, and Homebrew really, really
  # cares about version numbers. Which is fine. So be it. So it goes.
  VERSION="$(date "+%Y.%m.%d").$GITHUB_RUN_NUMBER"
  RELEASE_TAG="release_$VERSION"

  PRERELEASE='false'
else
  # We need this to be the same across all builds for a branch so we only ever keep the
  # latest tag+release for a given branch, or we’d have way too many tags+branches.
  RELEASE_TAG="prerelease_$GITHUB_REF"
  PRERELEASE='true'
fi

# These lines use a GHA construct called a “Workflow Command”
#  see https://help.github.com/en/actions/reference/workflow-commands-for-github-actions
echo "::set-env name=RELEASE_TAG::$RELEASE_TAG"
echo "::set-env name=PRERELEASE::$PRERELEASE"
